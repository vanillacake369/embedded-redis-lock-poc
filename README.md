# 레디스를 활용한 선점 처리

## 방안 1) Shared Lock 사용

> 뮤텍스/세마포어 해결을 위한 방안

## 방안 2) Hashes TTL 사용

> 선점 프로세스를 처리하기 위한 방안

### 해당 방안의 제한점

> Redis 7.4부터 RSALv2, 서버 사이드 퍼블릭 라이선스 이중 라이센스가 적용되면서, 클라우드 서비스 제공자의 상업적 이용이 제한되었다.
> 오픈소스 버전의 Redis 기반의 AWS ElastiCache 를 사용하고자한다면 HEXPIRE와 같은 신규 기능을 사용하기 어려울 것이다.
> [공식문서](https://redis.io/blog/redis-adopts-dual-source-available-licensing/)

# 시나리오

> 가정
> 액터 : 사용자 A, 사용자 B
> 유스케이스 : 같은 좌석을 선택하여 결제한다.

## 동시성 시나리오

1. 액터 A 와 액터 B 가 같은 좌석을 선택한다.
2. 먼저 접근한 액터에 대해 공유 락 획득권을 제공한다.
3. 이외 액터들은 재시도 처리를 하거나 큐에 쌓아놓는다.
4. 공유 락을 획득한 액터는 좌석 결제를 시도한다.
5. 좌석 결제 성공 시 액터는 좌석상태를 완료로 변경, 공유 락을 해제한다.
6. 좌석 결제 실패 시 액터는 좌석상태를 미판매건으로 유지, 공유 락을 해제한다.
7. 다음 공유 락을 획득한 액터가 좌석 결제를 시도한다.
8. 4 ~ 7 을 반복한다.

## 선점 시나리오

1. 액터 A 와 액터 B 가 같은 좌석을 선택한다.
2. 먼저 접근한 액터가 Redis Hash 에 있는 좌석 선점 여부를 조회한다.
3. 좌석 선점 여부가 없다면 먼저 접근한 액터가 좌석 선점 여부를 TTL 과 함께 저장한다.
4. 이외 액터들은 재시도 처리를 하거나 큐에 쌓아놓는다.
5. 좌석 선점 여부를 쌓은 액터는 좌석 결제를 시도한다.
6. 좌석 결제 성공 시 액터는 좌석상태를 완료로 변경, 선점 여부 저장값을 Redis Hash 에서 삭제한다.
7. 좌석 결제 실패 시 액터는 좌석상태를 미판매건으로 유지, 선점 여부 저장값을 Redis Hash 에서 삭제한다.
8. 다음 공유 락을 획득한 액터가 좌석 결제를 시도한다.
9. 5 ~ 8 을 반복한다. 